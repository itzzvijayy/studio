rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * VISION-AI CLEAN MADURAI - SECURITY RULES
     * Version: 2024-05-20T17:15:00Z
     * Purpose: Ensure public visibility for city cleanup reports while protecting user identities.
     */

    // --- USER PROFILES ---
    match /users/{userId} {
      // Users can manage their own profile. Listing all users is disabled for privacy.
      allow get, write: if request.auth != null && request.auth.uid == userId;
      allow list: if false;
    }

    // --- WASTE COMPLAINTS ---
    match /complaints/{complaintId} {
      // allow read covers both 'get' (single doc) and 'list' (collection queries)
      // Any authenticated user (including anonymous) can view the public feed.
      allow read: if request.auth != null;

      // Authenticated users can submit new reports.
      allow create: if request.auth != null;

      // Only the original reporter can update or delete their report.
      // This is secured by checking the 'userId' field in the document data.
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // --- GLOBAL DENY ---
    match /{path=**} {
      allow read, write: if false;
    }
  }
}